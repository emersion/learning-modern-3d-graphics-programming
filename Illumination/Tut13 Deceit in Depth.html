<html><head>


<script type="text/javascript" src="/static/js/analytics.js"></script>
<script type="text/javascript">archive_analytics.values.server_name="wwwb-app16.us.archive.org";archive_analytics.values.server_ms=135;</script>
<link type="text/css" rel="stylesheet" href="/static/css/banner-styles.css"/>


      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <meta http-equiv="X-UA-Compatible" content="IE=Edge"><title>Deceit in Depth</title><link rel="stylesheet" href="chunked.css" type="text/css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.75.2"><link rel="home" href="../index.html" title="Learning Modern 3D Graphics Programming"><link rel="up" href="Tutorial 13.html" title="Chapter&nbsp;13.&nbsp;Lies and Impostors"><link rel="prev" href="Tut13 Correct Chicanery.html" title="Correct Chicanery"><link rel="next" href="Tut13 Purloined Primitives.html" title="Purloined Primitives"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">


<!-- BEGIN WAYBACK TOOLBAR INSERT -->
<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript" src="/static/jflot/jquery.min.js" ></script>
<script type="text/javascript">//<![CDATA[
var __wm = (function(){
var wbPrefix = "/web/";
var wbCurrentUrl = "http://www.arcsynthesis.org/gltut/Illumination/Tut13%20Deceit%20in%20Depth.html";

var firstYear = 1996;
var imgWidth = 500,imgHeight = 27;
var yearImgWidth = 25,monthImgWidth = 2;
var displayDay = "25";
var displayMonth = "Feb";
var displayYear = "2015";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
var $D=document,$=function(n){return document.getElementById(n)};
var trackerVal,curYear = -1,curMonth = -1;
var yearTracker,monthTracker;
function showTrackers(val) {
  if (val===trackerVal) return;
  var $ipp=$("wm-ipp");
  var $y=$("displayYearEl"),$m=$("displayMonthEl"),$d=$("displayDayEl");
  if (val) {
    $ipp.className="hi";
  } else {
    $ipp.className="";
    $y.innerHTML=displayYear;$m.innerHTML=displayMonth;$d.innerHTML=displayDay;
  }
  yearTracker.style.display=val?"inline":"none";
  monthTracker.style.display=val?"inline":"none";
  trackerVal = val;
}
function getElementX2(obj) {
  var $e=jQuery(obj);
  return (typeof $e=="undefined"||typeof $e.offset=="undefined")?
    getElementX(obj):Math.round($e.offset().left);
}
function trackMouseMove(event,element) {
  var eventX = getEventX(event);
  var elementX = getElementX2(element);
  var xOff = Math.min(Math.max(0, eventX - elementX),imgWidth);
  var monthOff = xOff % yearImgWidth;

  var year = Math.floor(xOff / yearImgWidth);
  var monthOfYear = Math.min(11,Math.floor(monthOff / monthImgWidth));
  // 1 extra border pixel at the left edge of the year:
  var month = (year * 12) + monthOfYear;
  var day = monthOff % 2==1?15:1;
  var dateString = zeroPad(year + firstYear) + zeroPad(monthOfYear+1,2) +
    zeroPad(day,2) + "000000";

  $("displayYearEl").innerHTML=year+firstYear;
  $("displayMonthEl").innerHTML=prettyMonths[monthOfYear];
  // looks too jarring when it changes..
  //$("displayDayEl").innerHTML=zeroPad(day,2);
  var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
  $("wm-graph-anchor").href=url;

  if(curYear != year) {
    var yrOff = year * yearImgWidth;
    yearTracker.style.left = yrOff + "px";
    curYear = year;
  }
  if(curMonth != month) {
    var mtOff = year + (month * monthImgWidth) + 1;
    monthTracker.style.left = mtOff + "px";
    curMonth = month;
  }
}
function hideToolbar() {
  $("wm-ipp").style.display="none";
}
function bootstrap() {
  var $spk=$("wm-ipp-sparkline");
  yearTracker=$D.createElement('div');
  yearTracker.className='yt';
  with(yearTracker.style){
    display='none';width=yearImgWidth+"px";height=imgHeight+"px";
  }
  monthTracker=$D.createElement('div');
  monthTracker.className='mt';
  with(monthTracker.style){
    display='none';width=monthImgWidth+"px";height=imgHeight+"px";
  }
  $spk.appendChild(yearTracker);
  $spk.appendChild(monthTracker);

  var $ipp=$("wm-ipp");
  $ipp&&disclaimElement($ipp);
}
return{st:showTrackers,mv:trackMouseMove,h:hideToolbar,bt:bootstrap};
})();//]]>
</script>
<style type="text/css">
body {
  margin-top:0 !important;
  padding-top:0 !important;
  min-width:800px !important;
}
</style>
<div id="wm-ipp" lang="en" style="display:none;">

<div style="position:fixed;left:0;top:0;width:100%!important">
<div id="wm-ipp-inside">
   <table style="width:100%;"><tbody><tr>
   <td id="wm-logo">
       <a href="/web/" title="Wayback Machine home page"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0" /></a>
   </td>
   <td class="c">
       <table style="margin:0 auto;"><tbody><tr>
       <td class="u" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb"><input type="text" name="url" id="wmtbURL" value="http://www.arcsynthesis.org/gltut/Illumination/Tut13%20Deceit%20in%20Depth.html" style="width:400px;" onfocus="this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20150225192607" /><input type="submit" value="Go" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td class="n" rowspan="2">
           <table><tbody>
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr class="m">
           	<td class="b" nowrap="nowrap">
		
		    <a href="/web/20140813150451/http://www.arcsynthesis.org/gltut/Illumination/Tut13%20Deceit%20in%20Depth.html" title="13 Aug 2014">AUG</a>
		
		</td>
		<td class="c" id="displayMonthEl" title="You are here: 19:26:07 Feb 25, 2015">FEB</td>
		<td class="f" nowrap="nowrap">
		
		    Mar
		
                </td>
	    </tr>
           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr class="d">
               <td class="b" nowrap="nowrap">
               
                   <a href="/web/20140813150451/http://www.arcsynthesis.org/gltut/Illumination/Tut13%20Deceit%20in%20Depth.html" title="15:04:51 Aug 13, 2014"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
               
               </td>
               <td class="c" id="displayDayEl" style="width:34px;font-size:24px;" title="You are here: 19:26:07 Feb 25, 2015">25</td>
	       <td class="f" nowrap="nowrap">
               
                   <img src="/static/images/toolbar/wm_tb_nxt_off.png" alt="Next capture" width="14" height="16" border="0"/>
               
	       </td>
           </tr>
           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr class="y">
	       <td class="b" nowrap="nowrap">
               
                   <a href="/web/20131205182210/http://www.arcsynthesis.org/gltut/Illumination/Tut13%20Deceit%20in%20Depth.html" title="5 Dec 2013"><strong>2013</strong></a>
               
               </td>
               <td class="c" id="displayYearEl" title="You are here: 19:26:07 Feb 25, 2015">2015</td>
	       <td class="f" nowrap="nowrap">
               
                   2016
               
	       </td>
           </tr>
           </tbody></table>
       </td>
       </tr>
       <tr>
       <td class="s">
           <a class="t" href="/web/20150225192607*/http://www.arcsynthesis.org/gltut/Illumination/Tut13%20Deceit%20in%20Depth.html" title="See a list of every capture for this URL">27 captures</a>
           <div class="r" title="Timespan for captures of this URL">13 May 11 - 25 Feb 15</div>
       </td>
       <td class="k">
       <a href="" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" title="Explore captures for this URL">
	 <img id="sparklineImgId" alt="sparklines"
		 onmouseover="__wm.st(1)" onmouseout="__wm.st(0)"
		 onmousemove="__wm.mv(event,this)"
		 width="500"
		 height="27"
		 border="0"
		 src="/web/jsp/graph.jsp?graphdata=500_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000000000000_2007:-1:000000000000_2008:-1:000000000000_2009:-1:000000000000_2010:-1:000000000000_2011:-1:000010111010_2012:-1:211121000020_2013:-1:001001211111_2014:-1:000100010000_2015:1:010000000000" />
       </div>
       </a>
       </td>
       </tr></tbody></table>
   </td>
   <td class="r">
       <a href="#close" onclick="__wm.h();return false;" style="background-image:url(/static/images/toolbar/wm_tb_close.png);top:5px;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="background-image:url(/static/images/toolbar/wm_tb_help.png);bottom:5px;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>
</div>
</div>
</div>
<script type="text/javascript">__wm.bt();</script>
<!-- END WAYBACK TOOLBAR INSERT -->
<div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Deceit in Depth</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="Tut13 Correct Chicanery.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;13.&nbsp;Lies and Impostors</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="Tut13 Purloined Primitives.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12930"></a>Deceit in Depth</h2></div></div></div><p>While the perspective version looks great, there remains one problem. Move the time
            around until the rotating grey sphere ducks underneath the ground.</p><div class="figure"><a name="d0e12936"></a><p class="title"><b>Figure&nbsp;13.6.&nbsp;Bad Intersection</b></p><div class="figure-contents"><div class="mediaobject"><img src="Bad%20Impostor%20Intersection.png" alt="Bad Intersection"></div></div></div><br class="figure-break"><p>Hmm. Even though we've made it look like a mathematically perfect sphere, it does not
            act like one to the depth buffer. As far as it is concerned, it's just a circle
            (remember: <code class="literal">discard</code> prevents depth writes and tests as well).</p><p>Is that the end for our impostors? Hardly.</p><p>Part of the fragment shader's output is a depth value. If you do not write one, then
            OpenGL will happily use <code class="varname">gl_FragCoord.z</code> as the depth output from the
            fragment shader. This value will be depth tested against the current depth value and, if
            the test passes, written to the depth buffer.</p><p>But we do have the ability to write a depth value ourselves. To see how this is done,
            load up the tutorial (using the same code again) and press the <span class="keycap"><strong>H</strong></span> key.
            This will cause all impostors to use depth-correct shaders.</p><div class="figure"><a name="d0e12959"></a><p class="title"><b>Figure&nbsp;13.7.&nbsp;Depth Correct Impostor</b></p><div class="figure-contents"><div class="mediaobject"><img src="Depth%20Correct%20Impostor.png" alt="Depth Correct Impostor"></div></div></div><br class="figure-break"><p>This shader is identical to the ray traced version, except for these lines in the
            fragment shader:</p><div class="example"><a name="d0e12967"></a><p class="title"><b>Example&nbsp;13.4.&nbsp;Depth Correct Fragment Shader</b></p><div class="example-contents"><pre class="programlisting">Impostor(cameraPos, cameraNormal);
	
<span class="code-comment">//Set the depth based on the new cameraPos.</span>
<span class="code-type">vec4</span> clipPos = cameraToClipMatrix * <span class="code-type">vec4</span>(cameraPos, <span class="code-number">1.0</span>);
<span class="code-type">float</span> ndcDepth = clipPos.z / clipPos.w;
gl_FragDepth = ((gl_DepthRange.diff * ndcDepth) +
    gl_DepthRange.near + gl_DepthRange.far) / <span class="code-number">2.0</span>;</pre></div></div><br class="example-break"><p>Basically, we go through the process OpenGL normally goes through to compute the
            depth. We just do it on the camera-space position we computed with the ray tracing
            function. The position is transformed to clip space. The perspective division happens,
            transforming to normalized device coordinate (<acronym class="acronym">NDC</acronym>) space. The depth
            range function is applied, forcing the [-1, 1] range in the fragment shader to the range
            that the user provided with <code class="function">glDepthRange.</code></p><p>We write the final depth to a built-in output variable
                <code class="varname">gl_FragDepth.</code></p><div class="sidebar"><p class="title"><b>Fragments and Depth</b></p><p>The default behavior of OpenGL is, if a fragment shader does not write to the
                output depth, then simply take the <code class="varname">gl_FragCoord.z</code> depth as the
                depth of the fragment. Oh, you could do this manually. One could add the following
                statement to any fragment shader that uses the default depth value:</p><pre class="programlisting">gl_FragDepth = gl_FragCoord.z</pre><p>This is, in terms of behavior a noop; it does nothing OpenGL would not have done
                itself. However, in terms of <span class="emphasis"><em>performance</em></span>, this is a drastic
                change.</p><p>The reason fragment shaders are not required to have this line in all of them is
                to allow for certain optimizations. If the OpenGL driver can see that you do not set
                    <code class="varname">gl_FragDepth</code> anywhere in the fragment shader, then it can
                dramatically improve performance in certain cases.</p><p>If the driver knows that the output fragment depth is the same as the generated
                one, it can do the whole depth test <span class="emphasis"><em>before</em></span> executing the
                fragment shader. This is called <em class="glossterm">early depth test</em> or
                    <em class="glossterm">early-z</em>. This means that it can discard fragments
                    <span class="emphasis"><em>before</em></span> wasting precious time executing potentially complex
                fragment shaders. Indeed, most hardware nowadays has complicated early z culling
                hardware that can discard multiple fragments with a single test.</p><p>The moment your fragment shader writes anything to
                <code class="varname">gl_FragDepth</code>, all of those optimizations have to go away. So
                generally, you should only write a depth value yourself if you
                    <span class="emphasis"><em>really</em></span> need to do it.</p><p>Also, if your shader writes <code class="varname">gl_FragDepth</code> anywhere, it must
                ensure that it is <span class="emphasis"><em>always</em></span> written to, no matter what conditional
                branches your shader uses. The value is not initialized to a default; you either
                always write to it or never mention <span class="quote">&#8220;<span class="quote"><code class="varname">gl_FragDepth</code></span>&#8221;</span>
                in your fragment shader at all. Obviously, you do not always have to write the same
                value; you can conditionally write different values. But you cannot write something
                in one path and not write something in another. Initialize it explicitly with
                    <code class="varname">gl_FragCoord.z</code> if you want to do something like that.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="Tut13 Correct Chicanery.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="Tutorial 13.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="Tut13 Purloined Primitives.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Correct Chicanery&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="/web/20150225192607/http://www.arcsynthesis.org/gltut/index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Purloined Primitives</td></tr></table></div></body></html>




<!--
     FILE ARCHIVED ON 19:26:07 Feb 25, 2015 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 19:09:30 Mar 29, 2015.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
